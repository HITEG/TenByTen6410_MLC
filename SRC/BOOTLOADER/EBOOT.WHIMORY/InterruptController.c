#include "interruptController.h"

volatile S3C6410_VIC_REG *s6410VIC0;
volatile S3C6410_VIC_REG *s6410VIC1;
static void (*intHandlerTable[65])(void);

void Isr_Init(void);
extern void ASM_IsrHandler(void);

void VIC_setHandler(unsigned intNum, void (*handler)(void) )
{
	intHandlerTable[intNum]=handler;
}

static void VIC_ClearVectAddr(void);

void C_IsrHandler(unsigned int val)
{
    unsigned  irq;

    irq = (s6410VIC0->VICADDRESS)&0xff;
	VIC_InterruptDisable(irq);
	intHandlerTable[irq]();
	VIC_InterruptEnable(irq);

    VIC_ClearVectAddr();
}


void VIC_InterruptEnable(UINT32 intNum)
{
    if(intNum<32)
    {
        s6410VIC0->VICINTENABLE = (1<<intNum);
    }
    else
    {
        s6410VIC1->VICINTENABLE = (1<<(intNum-32));
    }

    return;
}

void VIC_InterruptDisable(UINT32 intNum)
{
    if(intNum<32)
    {
        s6410VIC0->VICINTENCLEAR = (1<<intNum);
    }
    else
    {
        s6410VIC1->VICINTENCLEAR = (1<<(intNum-32));
    }

    return;
}

static void VIC_ClearVectAddr(void)
{
    s6410VIC0->VICADDRESS = 0x0;
    s6410VIC1->VICADDRESS = 0x0;

    return;
}

static void VIC_InitializeVectTable(void)
{
    s6410VIC0->VICVECTADDR0 = PHYIRQ_EINT0;
    s6410VIC0->VICVECTADDR1 = PHYIRQ_EINT1;
    s6410VIC0->VICVECTADDR2 = PHYIRQ_RTC_TIC;
    s6410VIC0->VICVECTADDR3 = PHYIRQ_CAMIF_C;
    s6410VIC0->VICVECTADDR4 = PHYIRQ_CAMIF_P;

    s6410VIC0->VICVECTADDR5 = PHYIRQ_I2C1;
    s6410VIC0->VICVECTADDR6 = PHYIRQ_I2S_V40;
    s6410VIC0->VICVECTADDR7 = PHYIRQ_SSS;
    s6410VIC0->VICVECTADDR8 = PHYIRQ_3D;

    s6410VIC0->VICVECTADDR9 = PHYIRQ_POST;
    s6410VIC0->VICVECTADDR10 = PHYIRQ_ROTATOR;
    s6410VIC0->VICVECTADDR11 = PHYIRQ_2D;
    s6410VIC0->VICVECTADDR12 = PHYIRQ_TVENC;
    s6410VIC0->VICVECTADDR13 = PHYIRQ_TVSCALER;
    s6410VIC0->VICVECTADDR14 = PHYIRQ_BATF;
    s6410VIC0->VICVECTADDR15 = PHYIRQ_JPEG;
    s6410VIC0->VICVECTADDR16 = PHYIRQ_MFC;
    s6410VIC0->VICVECTADDR17 = PHYIRQ_SDMA0;
    s6410VIC0->VICVECTADDR18 = PHYIRQ_SDMA1;
    s6410VIC0->VICVECTADDR19 = PHYIRQ_ARM_DMAERR;
    s6410VIC0->VICVECTADDR20 = PHYIRQ_ARM_DMA;
    s6410VIC0->VICVECTADDR21 = PHYIRQ_ARM_DMAS;
    s6410VIC0->VICVECTADDR22 = PHYIRQ_KEYPAD;
    s6410VIC0->VICVECTADDR23 = PHYIRQ_TIMER0;
    s6410VIC0->VICVECTADDR24 = PHYIRQ_TIMER1;
    s6410VIC0->VICVECTADDR25 = PHYIRQ_TIMER2;
    s6410VIC0->VICVECTADDR26 = PHYIRQ_WDT;
    s6410VIC0->VICVECTADDR27 = PHYIRQ_TIMER3;
    s6410VIC0->VICVECTADDR28 = PHYIRQ_TIMER4;
    s6410VIC0->VICVECTADDR29 = PHYIRQ_LCD0_FIFO;
    s6410VIC0->VICVECTADDR30 = PHYIRQ_LCD1_FRAME;
    s6410VIC0->VICVECTADDR31 = PHYIRQ_LCD2_SYSIF;

    s6410VIC1->VICVECTADDR0 = PHYIRQ_EINT2;
    s6410VIC1->VICVECTADDR1 = PHYIRQ_EINT3;
    s6410VIC1->VICVECTADDR2 = PHYIRQ_PCM0;
    s6410VIC1->VICVECTADDR3 = PHYIRQ_PCM1;
    s6410VIC1->VICVECTADDR4 = PHYIRQ_AC97;
    s6410VIC1->VICVECTADDR5 = PHYIRQ_UART0;
    s6410VIC1->VICVECTADDR6 = PHYIRQ_UART1;
    s6410VIC1->VICVECTADDR7 = PHYIRQ_UART2;
    s6410VIC1->VICVECTADDR8 = PHYIRQ_UART3;
    s6410VIC1->VICVECTADDR9 = PHYIRQ_DMA0;
    s6410VIC1->VICVECTADDR10 = PHYIRQ_DMA1;
    s6410VIC1->VICVECTADDR11 = PHYIRQ_ONENAND0;
    s6410VIC1->VICVECTADDR12 = PHYIRQ_ONENAND1;
    s6410VIC1->VICVECTADDR13 = PHYIRQ_NFC;
    s6410VIC1->VICVECTADDR14 = PHYIRQ_CFC;
    s6410VIC1->VICVECTADDR15 = PHYIRQ_UHOST;
    s6410VIC1->VICVECTADDR16 = PHYIRQ_SPI0;
    s6410VIC1->VICVECTADDR17 = PHYIRQ_SPI1;
    s6410VIC1->VICVECTADDR18 = PHYIRQ_I2C;
    s6410VIC1->VICVECTADDR19 = PHYIRQ_HSITX;
    s6410VIC1->VICVECTADDR20 = PHYIRQ_HSIRX;
    s6410VIC1->VICVECTADDR21 = PHYIRQ_RESERVED;
    s6410VIC1->VICVECTADDR22 = PHYIRQ_MSM;
    s6410VIC1->VICVECTADDR23 = PHYIRQ_HOSTIF;
    s6410VIC1->VICVECTADDR24 = PHYIRQ_HSMMC0;
    s6410VIC1->VICVECTADDR25 = PHYIRQ_HSMMC1;
    s6410VIC1->VICVECTADDR26 = PHYIRQ_OTG;
    s6410VIC1->VICVECTADDR27 = PHYIRQ_IRDA;
    s6410VIC1->VICVECTADDR28 = PHYIRQ_RTC_ALARM;
    s6410VIC1->VICVECTADDR29 = PHYIRQ_SEC;
    s6410VIC1->VICVECTADDR30 = PHYIRQ_PENDN;
    s6410VIC1->VICVECTADDR31 = PHYIRQ_ADC;
}



void InitializeInterrupt(void)
{
    s6410VIC0 = (S3C6410_VIC_REG *)OALPAtoVA(S3C6410_BASE_REG_PA_VIC0, FALSE);
    s6410VIC1 = (S3C6410_VIC_REG *)OALPAtoVA(S3C6410_BASE_REG_PA_VIC1, FALSE);

    System_DisableVIC();
    System_DisableIRQ();
    System_DisableFIQ();

    // Disable All Interrupts
    s6410VIC0->VICINTENCLEAR = 0xFFFFFFFF;
    s6410VIC1->VICINTENCLEAR = 0xFFFFFFFF;
    s6410VIC0->VICSOFTINTCLEAR = 0xFFFFFFFF;
    s6410VIC1->VICSOFTINTCLEAR = 0xFFFFFFFF;

    // All Interrupt is IRQ Mode
    s6410VIC0->VICINTSELECT = 0x0;
    s6410VIC1->VICINTSELECT = 0x0;

    // Clear Current Active Vector Address
    s6410VIC0->VICADDRESS = 0x0;
    s6410VIC1->VICADDRESS = 0x0;

    // Initialize Vector Table
    VIC_InitializeVectTable();

    EdbgOutputDebugString("INFO: (unsigned)C_IsrHandler : 0x%x\r\n", (unsigned)C_IsrHandler);
    EdbgOutputDebugString("INFO: (unsigned)ASM_IsrHandler : 0x%x\r\n", (unsigned)ASM_IsrHandler);

    // make value to assemble code "b IsrHandler"
    //EdbgOutputDebugString("INFO: (unsigned)pISR : 0x%x\r\n", (unsigned)pISR);
    pISR = (unsigned)(0xEA000000)+(((unsigned)ASM_IsrHandler -(DRAM_BASE_CA_START + 0x18 + 0x8))>>2);

    System_EnableIRQ();

    EdbgOutputDebugString("INFO: (unsigned)pISR : 0x%x\r\n", (unsigned)pISR);

    
}
